<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hebrew Bible EReader</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%3C/text%3E%3C/svg%3E"
    />
    <style>
      :root {
        --bg1: #667eea;
        --bg2: #764ba2;
        --ink: #222;
        --accent: #667eea;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
          sans-serif;
        line-height: 1.6;
        color: var(--ink);
        min-height: 100vh;
        background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
        padding: 22px;
      }
      .wrap {
        max-width: 900px;
        margin: 0 auto;
      }
      header {
        color: #fff;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        margin-bottom: 16px;
      }
      header h1 {
        margin: 0 0 6px;
        font-size: 1.9rem;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      .nav a {
        color: #fff;
        text-decoration: none;
        margin-right: 14px;
        font-weight: 600;
        border-bottom: 2px solid transparent;
        padding-bottom: 2px;
      }
      .nav a:hover {
        border-bottom-color: #fff;
      }
      .divider {
        height: 2px;
        margin-top: 10px;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0));
        border-radius: 2px;
      }
      .card {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        padding: 18px 20px;
        border-left: 4px solid var(--accent);
      }
      .he {
        direction: rtl;
        text-align: right;
        font-size: 1.22rem;
        margin: 6px 0 2px;
        font-weight: 600;
        font-family: "NotoSerifHebrew", "Noto Sans Hebrew", Tahoma, Arial, sans-serif;
      }
      .en {
        color: #555;
        margin: 0 0 8px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Hebrew Bible EReader</h1>
        <div class="nav">
          <a href="#gallery">Gallery</a>
          <a href="tanakh.epub">The Book (EPUB)</a>
        </div>
        <div class="divider"></div>
      </header>

      <section class="card">
        <div class="he">砖  拽砖 专  砖转</div>
        <div class="en">For the sake of the unity of the Holy Blessed One and His Presence.</div>

        <div class="he">专 驻住 专 转专 砖 爪</div>
        <div class="en">Behold, I publish these words of Torah for the sake of the mitzvah,</div>

        <div class="he">砖 专 , 注转, 注专专 转   砖砖.</div>
        <div class="en">
          that they may help many to learn, to understand, and to awaken the heart toward our Father
          in Heaven.
        </div>
      </section>
      <!-- Gallery Section -->
      <section
        id="gallery"
        class="card"
        style="margin-top: 16px; background: rgba(255, 255, 255, 0.95)"
      >
        <div class="en" style="margin-bottom: 10px; font-weight: 600; color: #333">
          Marc Chagall Bible Illustrations
        </div>
        <div id="gallery-content"></div>
      </section>
    </div>

    <!-- Modal for displaying full-size images -->
    <div id="imageModal" class="modal">
      <span class="close">&times;</span>
      <img class="modal-content" id="modalImage" />
      <div id="modalCaption" class="modal-caption"></div>
    </div>

    <script>
      // Minimal gallery logic
      function romanToInt(roman) {
        if (!roman) return null;
        const values = { I: 1, V: 5, X: 10, L: 50, C: 100, D: 500, M: 1000 };
        let sum = 0,
          prev = 0;
        for (let i = roman.length - 1; i >= 0; i--) {
          const c = roman[i].toUpperCase();
          const val = values[c];
          if (!val) return null;
          if (val < prev) sum -= val;
          else sum += val;
          prev = val;
        }
        return sum || null;
      }

      function extractSubjectRef(desc) {
        if (!desc) return null;
        const parenMatch = desc.match(/\(([^()]+)\)\s*$/);
        if (!parenMatch) return null;
        const inside = parenMatch[1];
        const refMatch = inside.match(/^(.*?)\s*[,\s]*([IVXLCDM]+)\b/i);
        if (!refMatch) return null;
        let bookRaw = refMatch[1].trim();
        const roman = (refMatch[2] || "").toUpperCase();
        const chapter = romanToInt(roman);
        if (!bookRaw || !chapter) return null;
        const bookNorm = bookRaw
          .replace(/\bI\b\s*_?/g, "I ")
          .replace(/\bII\b\s*_?/g, "II ")
          .replace(/_/g, " ")
          .replace(/\s+/g, " ")
          .trim();
        return `${bookNorm} ${chapter}`;
      }

      async function loadImageConfig() {
        async function tryLoad(url) {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        }
        try {
          // Try local path first (works when served from repo root on GH Pages)
          const items = await tryLoad("chagall_download_config.json");
          const byBook = new Map();
          for (const it of items) {
            const book = it.book || "General";
            if (!byBook.has(book)) byBook.set(book, []);
            byBook.get(book).push(it);
          }
          return byBook;
        } catch (e1) {
          console.warn("Local config missing; trying raw.githubusercontent fallback");
          try {
            const rawUrl =
              "https://raw.githubusercontent.com/posix4e/hebrew-bible-ereader/main/chagall_download_config.json";
            const items = await fetch(rawUrl, { cache: "no-store" }).then((r) => r.json());
            const byBook = new Map();
            for (const it of items) {
              const book = it.book || "General";
              if (!byBook.has(book)) byBook.set(book, []);
              byBook.get(book).push(it);
            }
            return byBook;
          } catch (e2) {
            console.error("Failed to load chagall_download_config.json", e2);
            return new Map();
          }
        }
      }

      async function generateGallery() {
        const container = document.getElementById("gallery-content");
        const byBook = await loadImageConfig();
        const bookOrder = [
          "Genesis",
          "Exodus",
          "Leviticus",
          "Numbers",
          "Deuteronomy",
          "Joshua",
          "Judges",
          "I_Samuel",
          "II_Samuel",
          "I_Kings",
          "II_Kings",
          "Isaiah",
          "Jeremiah",
          "Ezekiel",
          "Hosea",
          "Joel",
          "Amos",
          "Obadiah",
          "Jonah",
          "Micah",
          "Nahum",
          "Habakkuk",
          "Zephaniah",
          "Haggai",
          "Zechariah",
          "Malachi",
          "Psalms",
          "Proverbs",
          "Job",
          "Song_of_Songs",
          "Ruth",
          "Lamentations",
          "Ecclesiastes",
          "Esther",
          "Daniel",
          "Ezra",
          "Nehemiah",
          "I_Chronicles",
          "II_Chronicles",
          "General",
        ];
        const books = Array.from(byBook.keys()).sort((a, b) => {
          const ai = bookOrder.indexOf(a),
            bi = bookOrder.indexOf(b);
          if (ai === -1 && bi === -1) return a.localeCompare(b);
          if (ai === -1) return 1;
          if (bi === -1) return -1;
          return ai - bi;
        });
        let html = "";
        for (const book of books) {
          const images = byBook.get(book);
          const bookTitle = book && book.indexOf("_") !== -1 ? book.split("_").join(" ") : book;
          html += `<div class="book-section">`;
          html += `<h2 class="book-title">${bookTitle}</h2>`;
          html += `<div class="image-grid">`;
          images.forEach((img) => {
            const subjectRef = extractSubjectRef(img.title);
            const placementText = subjectRef
              ? `<div class="chapter-placement"> ${subjectRef}</div>`
              : "";
            const safeTitle = img.title.replace(/'/g, "\\'");
            html += `
              <div class="image-card">
                <img src="images/${img.filename}" alt="${safeTitle}" onclick="openModal('images/${img.filename}', '${safeTitle}')" loading="lazy">
                <div class="image-info">
                  <div class="image-title">${img.title}</div>
                  <div class="image-description"></div>
                  ${placementText}
                </div>
              </div>
            `;
          });
          html += `</div></div>`;
        }
        container.innerHTML = books.length
          ? html
          : '<div class="image-info"><strong>Unable to load gallery data.</strong> Please refresh.</div>';
      }

      function openModal(imgSrc, caption) {
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        const captionText = document.getElementById("modalCaption");
        modal.style.display = "block";
        modalImg.src = imgSrc;
        captionText.innerHTML = caption;
      }
      document.addEventListener("DOMContentLoaded", () => {
        const c = document.querySelector(".close");
        if (c) c.onclick = () => (document.getElementById("imageModal").style.display = "none");
        document.getElementById("imageModal").onclick = function (event) {
          if (event.target.id === "imageModal") this.style.display = "none";
        };
        generateGallery();
      });
    </script>
  </body>
</html>
